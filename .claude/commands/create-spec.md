---
description: docs/features/ 配下の実装計画から詳細な仕様書を作成する
---

# 仕様書作成コマンド

`docs/features/` 配下の実装計画から、**Rails 8/React/TypeScript のベストプラクティスに完全準拠した**詳細な仕様書を作成してください。

## 🎯 目的

実装計画を具体的な技術仕様に落とし込み、以下を実現する:
- チーム全体で共通理解を持てる詳細な設計書
- そのまま実装に移れるレベルの具体性
- テスト駆動開発(TDD)が可能なテストケース定義
- セキュリティ・パフォーマンス・保守性を考慮した設計

## 📋 実行手順

### 1. 実装計画の収集
```bash
# docs/features/ 配下のすべての .md ファイルを検索
# 各ファイルの内容を読み取り、分析
```

### 2. プロジェクト構成の確認（必須）

**⚠️ 重要: 仕様書作成前に必ず以下を実行してください**

#### A. `CLAUDE.md` の読み取り
```
Read(CLAUDE.md)
```
以下を理解してから仕様書を作成:
- プロジェクトアーキテクチャ
- マルチテナンシー実装（`Current.organization`）
- 認可システム（Pundit）
- バックグラウンドジョブ（Solid Queue）
- フロントエンド構成（HAML, Tailwind, React）
- テスト要件（RSpec, 90%以上カバレッジ）
- コーディング規約

#### B. 既存コードのパターン確認
以下のディレクトリから既存のパターンを把握:
- `app/models/` - モデルの命名、バリデーション、アソシエーション
- `app/controllers/` - コントローラーの構造、filters
- `app/policies/` - Pundit ポリシーのパターン
- `app/services/` - サービスクラスの設計
- `spec/` - RSpec テストの書き方
- `.rubocop.yml` - コーディングスタイル
- `package.json` - フロントエンド設定

#### C. Lint/Test設定の確認
- **RuboCop**: `.rubocop.yml` の設定に準拠
- **RSpec**: `spec/spec_helper.rb`, `spec/rails_helper.rb` の設定
- **ESLint**: `.eslintrc.js` または `package.json` の設定
- **TypeScript**: `tsconfig.json` の型チェック設定
- **HAML-Lint**: `.haml-lint.yml` の設定

### 3. 仕様書の生成計画（チェックリスト形式）

各実装計画ファイルに対して、以下のチェックリストに従って仕様書を作成:

#### 事前準備チェックリスト
- [ ] `CLAUDE.md` を読み取り、プロジェクトアーキテクチャを理解
- [ ] `docs/features/` 配下の実装計画ファイルをすべて検索
- [ ] 対象ファイルの内容を読み取り
- [ ] 既存のモデル/コントローラー/ポリシーのパターンを確認
- [ ] Lint/Test設定ファイルを確認

#### 仕様書作成チェックリスト（各ファイルごと）
- [ ] 概要セクション作成（目的、対象ユーザー、優先度）
- [ ] 機能要件の詳細化（主要機能、副次的機能）
- [ ] データモデル設計（テーブル、カラム、インデックス、バリデーション）
- [ ] API エンドポイント設計（リクエスト/レスポンス形式）
- [ ] コントローラー設計（アクション、filters、認可）
- [ ] サービスクラス設計（責務、メソッド、依存関係）
- [ ] ビュー設計（HAML テンプレート、Tailwind CSS クラス）
- [ ] セキュリティ要件（OWASP Top 10 対策）
- [ ] パフォーマンス要件（レスポンス時間、N+1対策、キャッシング）
- [ ] テスト要件（RSpec テストケース、カバレッジ目標）
- [ ] エラーハンドリング（エラーケース、HTTPステータス）
- [ ] マイグレーション設計（DDL、インデックス、ロールバック戦略）
- [ ] UI/UX 仕様（レイアウト、アクセシビリティ）
- [ ] 国際化対応（i18n キー定義）
- [ ] 依存関係整理（Gem、npm パッケージ）
- [ ] デプロイ要件（環境変数、設定）
- [ ] 実装チェックリスト作成

#### 品質チェックリスト
- [ ] Rails 8 ベストプラクティスに準拠
- [ ] Pundit ポリシーパターンに準拠
- [ ] Solid Queue 設計パターンに準拠
- [ ] Tailwind CSS のみ使用（カスタムCSS禁止）
- [ ] HAML のみ使用（ERB禁止）
- [ ] TypeScript のみ使用（JavaScript禁止）
- [ ] セキュリティ対策（OWASP Top 10）を含む
- [ ] テストケースが TDD 可能なレベル
- [ ] N+1 クエリ対策を明記
- [ ] 適切なインデックス戦略を定義

#### 出力設定
- **保存先**: `docs/features/`（実装計画と同じディレクトリ）
- **命名規則**: `[元のファイル名]-spec.md`
  - 例: `permissions-implementation.md` → `permissions-implementation-spec.md`
- **形式**: Markdown（GitHub Flavored Markdown）

## 📐 ベストプラクティス適用ルール

### Rails 8 ベストプラクティス

**必須事項:**

1. **マルチテナンシー**: `Current.organization` によるテナント分離
2. **認可**: Pundit ポリシーによる権限管理
3. **バックグラウンドジョブ**: Solid Queue（Redis不要）
4. **バリデーション**: モデル層での厳密なバリデーション
5. **N+1クエリ防止**: `includes`, `preload`, `eager_load` の適切な使用
6. **インデックス**: 複合インデックスの戦略的配置
7. **トランザクション**: データ整合性が必要な処理は `transaction` で囲む
8. **Strong Parameters**: コントローラーでの厳密なパラメータ制御
9. **国際化(i18n)**: すべてのテキストを翻訳キー化
10. **Concerns**: 共通ロジックは適切に抽出

### セキュリティベストプラクティス (OWASP Top 10準拠)

**必須チェック項目:**

1. **認証**: Devise の全セキュリティモジュール有効化
2. **認可**: Pundit による細かい権限制御
3. **XSS防止**: デフォルトのエスケープ処理、`raw` の使用禁止
4. **CSRF対策**: `protect_from_forgery` の確認
5. **SQLインジェクション**: パラメータ化クエリ、生SQLの禁止
6. **Mass Assignment**: Strong Parameters の厳格な定義
7. **機密情報**: 環境変数での管理、コードへのハードコーディング禁止
8. **セッション管理**: タイムアウト設定、Secure/HttpOnly Cookie
9. **レート制限**: Rack::Attack による API 保護
10. **監査ログ**: 重要な操作は AuditLog に記録

### フロントエンドベストプラクティス

**Tailwind CSS:**
- カスタムCSSを書かない（87%削減を維持）
- ユーティリティクラスのみ使用
- レスポンシブデザイン（`sm:`, `md:`, `lg:`, `xl:` 修飾子）
- 確立された色パレットの使用（gray, blue, green, red）

**HAML:**
- 全ビューテンプレートは HAML（ERB禁止）
- 2スペースインデント
- `=` で出力、`-` でロジック

**TypeScript:**
- 全 JavaScript は TypeScript
- `any` 型の使用禁止
- 適切な型定義とインターフェース

**React:**
- 関数コンポーネント + Hooks
- PropTypes または TypeScript interface
- Turbo との共存（Progressive Enhancement）

### テストベストプラクティス

**RSpec:**
- モデル: バリデーション、アソシエーション、メソッドテスト
- コントローラー: 認証、認可、レスポンステスト
- システム: エンドツーエンドのユーザーフロー
- カバレッジ: 90%以上（SimpleCov）

**テストデータ:**
- FactoryBot でデータ生成
- Faker でランダムデータ
- トランザクション内でテスト実行

**外部API:**
- WebMock でスタブ化
- VCR で HTTP インタラクション記録

### パフォーマンスベストプラクティス

**データベース:**
- 適切なインデックス設計
- Bullet gem でN+1検出
- `explain` でクエリプラン確認
- カウンタキャッシュの活用

**キャッシング:**
- Solid Cache による効率的なキャッシュ
- Fragment caching
- Russian Doll caching
- 適切な有効期限設定

**フロントエンド:**
- アセットの最小化（esbuild）
- 画像の最適化
- Lazy loading
- Turbo による高速ページ遷移

## 📄 仕様書テンプレート

各仕様書には以下の項目を含めてください:

### 📄 仕様書のテンプレート

```markdown
# [機能名] 仕様書

## 📖 概要

- **目的**: [この機能の目的]
- **対象ユーザー**: [誰がこの機能を使うか]
- **優先度**: [High/Medium/Low]
- **実装状況**: [未実装/実装中/完了]

## 🎯 機能要件

### 主要機能

1. **[機能1の名前]**
   - 説明: [詳細な説明]
   - 入力: [必要な入力]
   - 出力: [期待される出力]
   - 制約: [制限事項]

2. **[機能2の名前]**
   - 説明: [詳細な説明]
   - 入力: [必要な入力]
   - 出力: [期待される出力]
   - 制約: [制限事項]

### 副次的機能

- [サブ機能1]
- [サブ機能2]

## 🏗️ 技術仕様

### データモデル

#### モデル1: [モデル名]

| カラム名 | 型 | NULL許可 | デフォルト | 説明 |
|---------|-----|---------|----------|------|
| id | integer | NO | auto | 主キー |
| [カラム名] | [型] | [YES/NO] | [値] | [説明] |

**インデックス:**
- `index_on_column_name` (column_name)
- `index_on_multiple` (column1, column2)

**バリデーション:**
- presence: [必須項目]
- uniqueness: [一意制約]
- length: [文字数制限]
- format: [フォーマット制約]

**アソシエーション:**
- belongs_to: [関連モデル]
- has_many: [関連モデル]

### API エンドポイント

#### エンドポイント1: [メソッド] [パス]

**リクエスト:**
```json
{
  "param1": "value",
  "param2": 123
}
```

**レスポンス (200 OK):**
```json
{
  "status": "success",
  "data": {
    "id": 1,
    "name": "example"
  }
}
```

**エラーレスポンス (400 Bad Request):**
```json
{
  "status": "error",
  "message": "エラーメッセージ",
  "errors": {
    "field": ["エラー詳細"]
  }
}
```

**認証:** [必要/不要]
**権限:** [必要な権限レベル]
**レート制限:** [制限内容]

### コントローラー

#### [コントローラー名]

**アクション:**
- `index`: [一覧表示の仕様]
- `show`: [詳細表示の仕様]
- `create`: [新規作成の仕様]
- `update`: [更新の仕様]
- `destroy`: [削除の仕様]

**Before filters:**
- authenticate_user!
- set_resource
- authorize_resource

### サービスクラス

#### [サービス名]

**責務:** [このサービスの役割]

**メソッド:**
- `execute`: [メイン処理]
- `validate`: [バリデーション]
- `process`: [処理ロジック]

**依存関係:**
- [依存する外部サービス]
- [依存するモデル]

### ビュー

#### [ビュー名]

**テンプレート:** `app/views/[path]/[name].html.haml`

**表示項目:**
- [項目1]
- [項目2]

**アクション:**
- [ボタン/リンク1]
- [ボタン/リンク2]

**JavaScript:** [必要な JS の説明]

## 🔐 セキュリティ要件

### 認証
- [認証方法]
- [セッション管理]

### 認可
- [権限チェック]
- [ポリシークラス]

### データ保護
- [暗号化要件]
- [機密情報の扱い]

### バリデーション
- [入力検証]
- [サニタイゼーション]

## ⚡ パフォーマンス要件

### レスポンス時間
- API: [目標時間]
- ページ読み込み: [目標時間]

### スケーラビリティ
- [同時接続数]
- [データ量の想定]

### キャッシング
- [キャッシュ戦略]
- [有効期限]

### データベース最適化
- [インデックス戦略]
- [N+1クエリ対策]

## 🧪 テスト要件

### モデルテスト

```ruby
RSpec.describe ModelName, type: :model do
  describe 'validations' do
    it { should validate_presence_of(:field) }
  end

  describe 'associations' do
    it { should belong_to(:related_model) }
  end

  describe '#method_name' do
    it 'returns expected result' do
      # テストコード
    end
  end
end
```

### コントローラーテスト

```ruby
RSpec.describe ControllerName, type: :controller do
  describe 'GET #index' do
    it 'returns success response' do
      # テストコード
    end
  end
end
```

### システムテスト

```ruby
RSpec.describe 'Feature Name', type: :system do
  scenario 'user can do something' do
    # テストコード
  end
end
```

### カバレッジ目標
- モデル: 100%
- コントローラー: 95%以上
- サービス: 100%
- 全体: 90%以上

## 📊 エラーハンドリング

### エラーケース

1. **[エラーケース1]**
   - 発生条件: [条件]
   - エラーメッセージ: [メッセージ]
   - HTTPステータス: [ステータスコード]
   - ユーザーへの表示: [表示内容]

2. **[エラーケース2]**
   - 発生条件: [条件]
   - エラーメッセージ: [メッセージ]
   - HTTPステータス: [ステータスコード]
   - ユーザーへの表示: [表示内容]

### ロギング
- [ログレベル]
- [ログ出力内容]

## 🔄 マイグレーション

### マイグレーションファイル

```ruby
class CreateTableName < ActiveRecord::Migration[8.0]
  def change
    create_table :table_name do |t|
      t.string :field_name
      t.references :related_model, foreign_key: true

      t.timestamps
    end

    add_index :table_name, :field_name
  end
end
```

### データ移行
- [既存データの扱い]
- [ロールバック戦略]

## 📱 UI/UX 仕様

### レイアウト
- [画面構成]
- [レスポンシブ対応]

### インタラクション
- [ユーザー操作]
- [フィードバック]

### アクセシビリティ
- [ARIA属性]
- [キーボード操作]

## 🌐 国際化 (i18n)

### 翻訳キー

```yaml
ja:
  models:
    model_name:
      attributes:
        field: "フィールド名"
  controllers:
    controller_name:
      create:
        success: "作成しました"
        error: "作成に失敗しました"
```

### 対応言語
- 日本語 (ja)
- 英語 (en)

## 📦 依存関係

### Gem
- [gem名]: [用途]

### npm パッケージ
- [パッケージ名]: [用途]

### 外部サービス
- [サービス名]: [用途]

## 🚀 デプロイ要件

### 環境変数
```bash
FEATURE_FLAG_NAME=true
API_KEY=xxx
```

### データベース
- [マイグレーション実行]
- [シードデータ]

### 設定ファイル
- [必要な設定]

## 📝 リリースノート

### バージョン 1.0.0
- 初回リリース
- [主要機能1]
- [主要機能2]

## 🔗 関連ドキュメント

- 実装計画: `docs/features/[original-file].md`
- API仕様: `docs/api/[related-api].md`
- データベース設計: `docs/db/schema.md`

## ✅ チェックリスト

実装前:
- [ ] 仕様レビュー完了
- [ ] データベース設計レビュー完了
- [ ] API設計レビュー完了
- [ ] セキュリティレビュー完了

実装中:
- [ ] モデル実装
- [ ] コントローラー実装
- [ ] ビュー実装
- [ ] テスト実装
- [ ] Lint通過
- [ ] テスト全件通過

実装後:
- [ ] コードレビュー完了
- [ ] QAテスト完了
- [ ] パフォーマンステスト完了
- [ ] ドキュメント更新完了
```

## 4. **品質基準**

作成する仕様書は以下の基準を満たすこと:

- ✅ **完全性**: 実装に必要な全ての情報を含む
- ✅ **明確性**: 曖昧さがなく、誰が読んでも同じ理解ができる
- ✅ **一貫性**: プロジェクト全体の設計思想と一貫している
- ✅ **実装可能性**: 実装計画の内容を具体的な技術仕様に落とし込む
- ✅ **テスト可能性**: テストケースが明確に定義されている

## 5. **出力形式**

- 日本語で記述
- Markdown形式
- コードブロックには適切な言語指定
- 見出しレベルを適切に使用
- テーブルやリストを活用して読みやすく

## 6. **引数の扱い**

このコマンドは引数を受け取り、カスタマイズされた仕様書生成が可能です:

### 引数なしの場合
```
/create-spec
```
- `docs/features/` 配下のすべての `.md` ファイルを対象
- 全ファイルの仕様書を生成

### 特定ファイルを指定
```
/create-spec permissions-implementation.md
```
- 指定されたファイルのみ仕様書を生成
- パスは `docs/features/` からの相対パス

### 複数ファイルを指定
```
/create-spec permissions-implementation.md quota-enforcement.md
```
- スペース区切りで複数ファイルを指定
- 各ファイルの仕様書を生成

### フォーカス指定
```
/create-spec --focus=api
```
- API設計に特化した仕様書を生成
- オプション: `api`, `database`, `security`, `testing`, `performance`

### カスタム要件
```
/create-spec --requirements="モバイルアプリとの連携を考慮"
```
- 特定の要件を仕様書に反映
- 複数の要件はカンマ区切り

### 組み合わせ
```
/create-spec permissions-implementation.md --focus=security --requirements="GDPR準拠,監査ログ強化"
```

## 7. **品質基準**

作成する仕様書は以下の基準を満たすこと:

- ✅ **完全性**: 実装に必要な全ての情報を含む
- ✅ **明確性**: 曖昧さがなく、誰が読んでも同じ理解ができる
- ✅ **一貫性**: プロジェクト全体の設計思想と一貫している
- ✅ **実装可能性**: 実装計画の内容を具体的な技術仕様に落とし込む
- ✅ **テスト可能性**: テストケースが明確に定義されている
- ✅ **ベストプラクティス準拠**: Rails 8/React/TypeScript のベストプラクティスに完全準拠
- ✅ **セキュリティ**: OWASP Top 10 に対する対策が明記されている
- ✅ **パフォーマンス**: スケーラビリティとパフォーマンスを考慮
- ✅ **保守性**: コードの可読性と保守性を重視

## 8. **出力形式**

- **言語**: 日本語（技術用語は英語併記）
- **形式**: Markdown（GitHub Flavored Markdown）
- **コードブロック**: 言語指定必須（ruby, javascript, typescript, yaml, json, bash など）
- **見出し**: 階層構造を適切に使用（# → ## → ### → ####）
- **テーブル**: 複雑なデータはテーブル形式
- **チェックリスト**: 実装ステップは `- [ ]` 形式
- **リンク**: 関連ドキュメントへの相対パス

## 9. **完了後の報告**

すべての仕様書を作成したら、以下を報告してください:

### サマリー表示
```markdown
## 📊 仕様書生成完了

### 生成されたファイル
1. `docs/features/permissions-implementation-spec.md` (15KB, 450行)
   - 権限管理機能の詳細仕様
   - 4つのポリシークラス定義
   - 25のテストケース

2. `docs/features/quota-enforcement-spec.md` (12KB, 380行)
   - クォータ制限機能の詳細仕様
   - 3つのバリデーター定義
   - 18のテストケース

### 主要な技術決定
- マルチテナンシー: Current.organization による分離
- 認可: Pundit ポリシーベース
- バックグラウンドジョブ: Solid Queue

### 次のステップ
1. 仕様書のレビュー
2. データベーススキーマの最終確認
3. 実装の開始（TDD推奨）
```

### 実装への移行提案
- 優先順位付き実装順序の提案
- 推定実装時間
- リスク項目の指摘
- 依存関係の明示

---

## ⚠️ 重要な注意事項

### 必須実行項目
1. **CLAUDE.md の読み取り**: 仕様書作成前に必ず `Read(CLAUDE.md)` を実行
2. **既存コード調査**: `app/models/`, `app/policies/`, `spec/` から既存パターンを把握
3. **Lint設定確認**: `.rubocop.yml`, `.eslintrc.js`, `.haml-lint.yml` を確認
4. **チェックリスト完遂**: 事前準備→作成→品質チェックの全チェックリストを完了

### 設計原則
1. **プロジェクト固有の情報を優先**: `CLAUDE.md` の内容に従う
2. **既存コードとの整合性**: 既存の命名規則、パターンを踏襲
3. **仮定の明記**: 不明な点は合理的な仮定を立て、その旨を明記
4. **ベストプラクティス完全準拠**: Rails 8、Pundit、Solid Queue、Tailwind CSS
5. **セキュリティ第一**: OWASP Top 10 への対策を必ず含める
6. **TDD可能**: テストケースが具体的で実装可能なレベル
7. **パフォーマンス重視**: N+1 クエリ対策、インデックス戦略を明確に
8. **完全な国際化**: すべてのテキストを i18n 対応
9. **Lint/Test通過**: RuboCop, RSpec, ESLint, TypeScript すべて通過する仕様

### 実装への配慮
- **マイグレーション**: ゼロダウンタイムデプロイを考慮
- **ロールバック**: すべての変更にロールバック戦略を定義
- **バックワード互換性**: 既存機能への影響を最小化
- **段階的リリース**: 機能フラグを使った段階的展開を考慮

---

**実行例:**

```
/create-spec
```
→ すべての実装計画から仕様書を生成

```
/create-spec permissions-implementation.md --focus=security
```
→ 権限管理機能のセキュリティ重視の仕様書を生成

```
/create-spec --requirements="モバイルアプリ連携,リアルタイム通知"
```
→ モバイルアプリ連携とリアルタイム通知を考慮した仕様書を生成
